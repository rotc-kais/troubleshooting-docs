---
kind:
  - Troubleshooting
products:
  - Alauda Container Platform
  - Alauda DevOps
  - Alauda AI
  - Alauda Application Services
  - Alauda Service Mesh
  - Alauda Developer Portal
ProductsVersion:
  - 4.1.0,4.2.x
---
<!-- A type of document that involves encountering a fault, diagnosing it, performing root cause analysis, and providing solutions. -->

# 自建VIP

多网卡环境下使用自建vip，无法通过vip进行访问 平台通过自建部署环境，不定时会有拉取镜像失败；平台加载异常 平台静置不操作一段时间后页面加载异常

## Cause
- 单播配置未指定src-ip或未排除自身IP导致主备切换异常
- /etc/kubernetes/keepalived/check.sh文件权限非root
- arping返回mac地址不唯一，内核参数配置不当
- 多网卡架构冲突导致网卡初始化延迟

## Resolution
- 添加vrrp_check_unicast_src配置，删除peer配置并重建keepalived容器
- 执行chown root:root /etc/kubernetes/keepalived/check.sh并重启容器
- 添加net.ipv4.conf.all.arp_announce=2和net.ipv4.conf.all.arp_ignore=1内核参数
- 等待br-bond1分配IP后执行crictl rm删除容器并重启服务

## [workaround]
- 手动重启keepalived容器
- 临时调整ssh版本或权限
- 手动清理异常ARP缓存
- 人工干预网卡初始化顺序

## [Related Information]
- Environment: 自建VIP环境的多网卡Kubernetes集群
- vrrp_check_unicast_src
- /etc/kubernetes/keepalived/check.sh
- arp_announce/arp_ignore
- br-bond1网卡
- crictl ps/rm命令
- alive.yaml配置文件
- Component: Kubernetes
- Page ID: 216107798
- Original Title: 自建VIP-keepalived
