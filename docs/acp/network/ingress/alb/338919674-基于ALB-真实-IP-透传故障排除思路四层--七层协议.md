---
kind:
  - Troubleshooting
products:
  - Alauda Container Platform
  - Alauda DevOps
  - Alauda AI
  - Alauda Application Services
  - Alauda Service Mesh
  - Alauda Developer Portal
ProductsVersion:
  - 4.1.0,4.2.x
---
<!-- A type of document that involves encountering a fault, diagnosing it, performing root cause analysis, and providing solutions. -->

# 基于ALB 真实 IP 透传故障排除思路（四层 & 七层协议）

四层转发时无法保留客户端源地址 七层服务无法获取真实客户端IP

## Cause
- 四层协议未使用metallb+lbsvc+externalTrafficPolicy: Local方案
- 七层协议未正确配置X-Real-IP/X-Forwarded-For头或存在参数修改

## Resolution
- 四层协议采用metallb+lbsvc并设置externalTrafficPolicy: Local
- 七层协议检查ALB配置是否包含：
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
并验证X-Forwarded-Port参数状态

## [workaround]

## [Related Information]
- Environment: Kubernetes集群使用ALB进行TCP/UDP四层转发或HTTP/HTTPS七层代理的环境
- metallb
- lbsvc
- externalTrafficPolicy
- X-Real-IP
- X-Forwarded-For
- X-Forwarded-Port
- proxy_set_header
- $remote_addr
- $proxy_add_x_forwarded_for
- Component: alb
- Page ID: 338919674
- Original Title: 基于ALB 真实 IP 透传故障排除思路（四层 & 七层协议）
