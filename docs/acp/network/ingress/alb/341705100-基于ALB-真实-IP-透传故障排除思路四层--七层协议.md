---kind:   - Troubleshootingproducts:    - Alauda Container Platform   - Alauda DevOps   - Alauda AI   - Alauda Application Services   - Alauda Service Mesh   - Alauda Developer PortalProductsVersion:   - 4.1.0,4.2.x---<!-- A type of document that involves encountering a fault, diag...it, performing root cause analysis, and providing solutions. --># 基于ALB 真实 IP 透传故障排除思路（四层 & 七层协议）四层转发无法保留客户端源IP 后端服务看到的客户端IP是VIP而非真实IP X-Forwarded-For头被中间设备覆盖或丢失## Cause- 四层转发未使用metallb+lbsvc+externalTrafficPolicy: Local方案- ALB缺失proxy_set_header配置- 中间设备（F5/CDN/WAF）修改或丢弃X-Forwarded-For头- 后端服务未正确解析X-Forwarded-For头- SSL卸载导致HTTPS请求头丢失## Resolution- kubectl -n cpaas-system get cm <alb-configmap> -o yaml | grep -A 10 "http-snippet"- proxy_set_header X-Forwarded-For "$http_x_forwarded_for, $remote_addr"- set_real_ip_from 10.0.0.0/8; real_ip_header X-Forwarded-For; real_ip_recursive on;- kubectl exec -it <alb-pod> -n <alb-namespace> -- tcpdump -A -s 0 'tcp port 80' | grep "X-Forwarded-For"- curl -H "X-Forwarded-For: 1.1.1.1" http://<服务IP>## [workaround]## [Related Information]- X-Forwarded-For- X-Real-IP- cpaas-system- metallb- externalTrafficPolicy- http-snippet- real_ip_header- proxy_set_header- Component: alb- Page ID: 341705100- Original Title: 基于ALB 真实 IP 透传故障排除思路（四层 & 七层协议）