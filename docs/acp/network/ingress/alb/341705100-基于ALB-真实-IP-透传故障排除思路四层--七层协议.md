---
kind:
  - Troubleshooting
products:
  - Alauda Container Platform
  - Alauda DevOps
  - Alauda AI
  - Alauda Application Services
  - Alauda Service Mesh
  - Alauda Developer Portal
ProductsVersion:
  - 4.1.0,4.2.x
---
<!-- A type of document that involves encountering a fault, diagnosing it, performing root cause analysis, and providing solutions. -->

# 基于ALB 真实 IP 透传故障排除思路（四层 & 七层协议）

后端服务看到的 IP 是 VIP 而非真实客户端 IP X-Forwarded-For 头被覆盖或丢失 后端服务获取到多个 IP

## Cause
- 中间设备（如 F5/CDN/WAF）覆盖或丢弃 X-Forwarded-For 头
- ALB 未正确配置 proxy_set_header 指令
- SSL 卸载导致头丢失
- 请求经过多级代理追加 IP

## Resolution
- 配置 metallb+lbsvc 并设置 externalTrafficPolicy: Local
- 在 ALB 配置中添加：proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
- 在后端 Nginx 配置中设置：set_real_ip_from 10.0.0.0/8; real_ip_header X-Forwarded-For; real_ip_recursive on;
- 使用 kubectl -n cpaas-system get cm <alb-configmap> -o yaml 检查 http-snippet 配置

## [workaround]
- 强制保留原始头：proxy_set_header X-Forwarded-For "$http_x_forwarded_for, $remote_addr"
- 在 HTTPS server 块显式传递头：proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
- 使用 curl -H "X-Forwarded-For: 1.1.1.1" http://<服务IP> 测试透传

## [Related Information]
- Environment: Kubernetes cpaas-system 命名空间下的 ALB，使用 Nginx 作为反向代理
- X-Forwarded-For
- X-Real-IP
- http-snippet
- cpaas-system
- kubectl get cm
- tcpdump
- metallb
- lbsvc
- externalTrafficPolicy
- Component: alb
- Page ID: 341705100
- Original Title: 基于ALB 真实 IP 透传故障排除思路（四层 & 七层协议）
