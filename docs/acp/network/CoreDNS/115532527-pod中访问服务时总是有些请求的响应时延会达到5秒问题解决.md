---
kind:
  - Troubleshooting
products:
  - Alauda Container Platform
  - Alauda DevOps
  - Alauda AI
  - Alauda Application Services
  - Alauda Service Mesh
  - Alauda Developer Portal
ProductsVersion:
  - 4.1.0,4.2.x
---
<!-- A type of document that involves encountering a fault, diagnosing it, performing root cause analysis, and providing solutions. -->

# pod中访问服务时，总是有些请求的响应时延会达到5秒问题解决

pod中访问服务时，部分请求的响应时延达到5秒 DNS请求未收到响应，超时5秒后重试成功 kube-dns抓包显示DNS请求中途被丢弃

## Cause
- 内核conntrack模块的bug导致并发相同五元组UDP报文冲突
- glibc/musl库的parallel query机制触发该问题
- kube-proxy的ipvs模式无法规避此问题

## Resolution
- 在resolv.conf添加options use-vc强制使用TCP协议
- 在resolv.conf添加options single-request-reopen或single-request
- 通过ENTRYPOINT/CMD脚本修改resolv.conf
- 使用pod的postStart hook注入配置
- 利用dnsConfig字段配置(k8s v1.9+)
- 使用ConfigMap覆盖/etc/resolv.conf
- 部署MutatingAdmissionWebhook自动注入配置

## [workaround]

## [Related Information]
- Environment: 通用
- resolv.conf
- options use-vc
- options single-request-reopen
- options single-request
- conntrack
- kube-dns
- glibc
- musl
- ipvs
- Component: CoreDNS
- Page ID: 115532527
- Original Title: pod中访问服务时，总是有些请求的响应时延会达到5秒问题解决
