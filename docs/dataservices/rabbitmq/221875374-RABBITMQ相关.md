---
kind:
  - Troubleshooting
products:
  - Alauda Container Platform
  - Alauda DevOps
  - Alauda AI
  - Alauda Application Services
  - Alauda Service Mesh
  - Alauda Developer Portal
ProductsVersion:
  - 4.1.0,4.2.x
---
<!-- A type of document that involves encountering a fault, diagnosing it, performing root cause analysis, and providing solutions. -->

# RABBITMQ相关

节点无法加入集群，报错 cluster formation failed 或 failed to connect to nodes 队列状态显示 flow/blocked，生产者停止发送消息 消息未被消费者确认且从队列中消失

## Cause
- 防火墙阻止了端口 4369 或 25672 通信
- 节点名称配置不一致（hostname 不匹配）
- 内存超过 vm_memory_high_watermark 或磁盘超过 disk_free_limit 阈值
- 消费者未正确发送 basic_ack 确认
- 消息未持久化时节点重启
- 网络不稳定或 heartbeat 参数配置过小

## Resolution
- 开放防火墙端口：sudo ufw allow 4369,25672/tcp
- 检查 /etc/rabbitmq/rabbitmq-env.conf 的 NODENAME 配置一致性
- 调整内存阈值：rabbitmqctl set_vm_memory_high_watermark 0.6
- 确保消费者代码包含 channel.basic_ack(delivery_tag)
- 创建队列时添加 durable=true 参数，发布消息时设置 delivery_mode=2
- 调整心跳间隔：AMQP 连接参数配置 heartbeat=600

## [workaround]
- 临时清除旧消息：rabbitmqctl purge_queue <queue_name>
- 重启阻塞节点：systemctl restart rabbitmq-server
- 网络中断期间启用消息持久化策略

## [Related Information]
- Environment: RabbitMQ 3.8.x, Erlang/OTP 23.x
- epmd
- 4369/tcp
- 25672/tcp
- NODENAME
- vm_memory_high_watermark
- disk_free_limit
- basic_ack
- delivery_mode
- durable
- heartbeat
- Component: rabbitmq
- Page ID: 221875374
- Original Title: RABBITMQ相关
